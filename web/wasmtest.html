<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="xterm.css" />
    <script type=module>
        import init, { Interpreter, Reader } from './worst.js';
        import { Terminal, Readline } from './deps.js';

        // async js funcs must take over doing interp.run()
        // otherwise Worst.eval() will run ahead of it and wait and stall
        class Handle {
            constructor(interp, handle) {
                this.interp = interp;
                this.handle = handle;
            }
            async stack_pop() {
                await Promise.resolve(undefined);
                let r = this.handle.stack_pop();
                await this.interp.run();
                return r;
            }
            async stack_push(v) {
                await Promise.resolve(undefined);
                let r = this.handle.stack_push(v);
                await this.interp.run();
                return r;
            }
            async complete(v) {
                await Promise.resolve(undefined);
                let r = this.handle.complete();
                await this.interp.run();
                return r;
            }
        }

        class Worst {
            constructor(onPause) {
                this.interp = new Interpreter();
                this.reader = new Reader();
                this.onPause = onPause;
            }

            define(name, def) {
                let self = this;
                async function wrapper(i) {
                    let h = new Handle(self.interp, i)
                    try {
                        await def(h)
                    } finally {
                        await h.complete()
                    }
                }
                wrapper.isJsDef = true; // mild hack
                wrapper.inner = def;
                this.interp.js_define(name, wrapper);
            }

            async step() {
                let r = this.interp.run();
                if (r === undefined) {
                    return undefined;
                } else if (r instanceof Promise) {
                    await r;
                } else {
                    await this.onPause(this);
                }
            }

            async eval(src) {
                this.reader.write(src);
                this.interp.eval_next_from(this.reader);
                while (await this.step() !== undefined) {}
            }

            reset() {
                this.interp.reset();
                this.reader.reset();
            }

            stack_push(v) { this.interp.stack_push(v); }
            stack_pop() { return this.interp.stack_pop(); }
        }

        let term = new Terminal({
            convertEol: true,
            fontFamily: 'Courier New',
        });
        let readline = new Readline();
        term.loadAddon(readline);

        term.open(document.getElementById('worst-terminal'));
        window.term = term;
        window.readline = readline;

        (async function() {
            term.write('Loading binary... ');
            await init();
            term.write('OK\n');

            let w = new Worst((w) => {
                console.log("oopsy! poo poo");
                w.interp.debug();
                w.reset();
            });
            
            // enable docs (these setup evals are just lil bits of worst/init)
            await w.eval(`define default-attributes [documentation-attribute]\n`);
            // not ideal: import some stuff and then overwrite it
            await w.eval(`import worst/misc\n`);

            w.define("print", async (i) => {
                term.writeUtf8(await i.stack_pop());
            });
            w.define("read-line", async function w_readline(i) {
                term.write("\n");
                let line = await readline.read("");
                await i.stack_push(line + "\n");
            });

            await w.eval(`import ui\n`);

            term.write('done loading :)\x1B[H\x1B[2J');

            await w.eval(`worst-repl\n`);
        })();
    </script>
  </head>
  <body>
      <div id="worst-terminal"></div>
  </body>
</html>

