<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="xterm.css" />
    <script type=module>
        import init, { Interpreter, Reader } from './worst.js';
        import { Terminal, Readline } from './deps.js';

        class Worst {
            constructor(onPause) {
                this.interp = new Interpreter();
                this.reader = new Reader();
                this.onPause = onPause;
            }
            define(name, def) {
                def.isJsDef = true; // mild hack
                this.interp.js_define(name, def);
            }
            async eval(src) {
                this.reader.write(src);
                this.interp.eval_next_from(this.reader);
                while (true) {
                    let r = this.interp.run();
                    if (r === undefined) break;
                    if (typeof r === "function" && r.isJsDef) {
                        await r(this);
                    } else {
                        await this.onPause(this);
                    }
                }
            }

            reset() {
                this.interp.reset();
                this.reader.reset();
            }

            stack_push(v) { this.interp.stack_push(v); }
            stack_pop() { return this.interp.stack_pop(); }
        }

        let term = new Terminal({
            convertEol: true,
            fontFamily: 'Courier New',
        });
        let readline = new Readline();
        term.loadAddon(readline);

        term.open(document.getElementById('worst-terminal'));
        window.term = term;
        window.readline = readline;

        (async function() {
            term.write('Loading binary... ');
            await init();
            term.write('OK\n');

            let w = new Worst((w) => {
                console.log("oopsy! poo poo");
                w.interp.debug();
                w.reset();
            });
            
            // not ideal: import some stuff and then overwrite it
            await w.eval(`import worst/misc\n`);

            w.define("print", async (i) => {
                term.writeUtf8(i.stack_pop());
            });
            w.define("read-line", async (i) => {
                term.write("\n");
                await readline.read("").then((line) => {
                    i.stack_push(line + "\n");
                });
            });

            await w.eval(`import ui\n`);

            term.write('done loading :)\x1B[H\x1B[2J');

            await w.eval(`worst-repl\n`);
        })();
    </script>
  </head>
  <body>
      <div id="worst-terminal"></div>
  </body>
</html>

